# MedDRA 용어 검색 가이드

## 검색 전략 개요

환자 증상을 MedDRA 코드로 변환하는 과정은 **LLT(최하위 용어) → PT(선호 용어)** 순서로 진행됩니다.

```
환자 증상 입력 → LLT 검색 → PT 코드 확인 → 계층 정보 조회
```

## 1. LLT(최하위 용어) 검색

### 파일: `ascii-281/llt.asc`

**구조:**
```
llt_code$llt_name$pt_code$[빈필드들]$llt_currency$
```

**필드 설명:**
- `llt_code`: LLT 고유 코드 (8자리 숫자)
- `llt_name`: 한글 용어명
- `pt_code`: 해당 LLT가 속한 PT 코드
- `llt_currency`: 사용 여부 (Y=현재 사용, N=구버전/비권장)

### 검색 예시

#### 예제 1: "두통" 검색

```bash
grep "두통" ascii-281/llt.asc
```

**결과:**
```
10004087$머리띠로 조이는 듯한 두통$10043269$$$$$$$Y$$
10008012$두통 또는 두통$10019211$$$$$$$N$$
10009698$군집성 두통$10059133$$$$$$$Y$$
10019211$두통$10019211$$$$$$$Y$$
```

**해석:**
- `10019211$두통$10019211`: LLT "두통" → PT "두통" (10019211)
- `llt_currency=Y`: 현재 사용 중인 용어
- LLT 코드와 PT 코드가 같으면 해당 용어가 선호 용어(PT)임을 의미

#### 예제 2: "복통" 검색

```bash
grep "복통" ascii-281/llt.asc | head -10
```

**결과:**
```
10000039$복통$10000081$$$$$$$N$$
10000040$복통$10000081$$$$$$$N$$
10000081$복통$10000081$$$$$$$Y$$
10000082$전반적 복통$10000081$$$$$$$Y$$
10000083$국소적 복통$10000081$$$$$$$Y$$
10000085$복통 NOS$10000081$$$$$$$Y$$
10000086$소화성 궤양형 복통$10000087$$$$$$$Y$$
10004226$복통$10000081$$$$$$$Y$$
```

**핵심 포인트:**
- 여러 LLT가 동일한 PT로 매핑됨 (10000081 "복통")
- "전반적 복통", "국소적 복통" → 모두 PT "복통"으로 통합
- `N$$`: 구버전 용어는 사용하지 않음 (Y만 선택)

#### 예제 3: "어지러움" 검색

```bash
grep "어지러움" ascii-281/llt.asc
```

**결과:**
```
10013573$어지러움$10013573$$$$$$$Y$$
10013574$어지러움$10013573$$$$$$$N$$
10049939$전위성 발작성 체위성 어지러움$10049939$$$$$$$Y$$
```

**주의사항:**
- 동일한 용어명이라도 다른 LLT 코드를 가질 수 있음
- `llt_currency=Y`인 코드를 우선 사용
- PT 코드: 10013573

## 2. PT(선호 용어) 조회

### 파일: `ascii-281/pt.asc`

**구조:**
```
pt_code$pt_name$$pt_soc_code$$$$$$$$
```

**필드 설명:**
- `pt_code`: PT 고유 코드
- `pt_name`: 한글 선호 용어명
- `pt_soc_code`: 주(Primary) SOC 코드

### 조회 예시

```bash
grep "^10019211\|^10013573\|^10000081" ascii-281/pt.asc
```

**결과:**
```
10000081$복통$$10017947$$$$$$$$
10013573$어지러움$$10029205$$$$$$$$
10019211$두통$$10029205$$$$$$$$
```

**해석:**
- 10000081 (복통) → SOC 10017947 (각종 위장관 장애)
- 10013573 (어지러움) → SOC 10029205 (각종 신경계 장애)
- 10019211 (두통) → SOC 10029205 (각종 신경계 장애)

## 3. 검색 알고리즘

### 기본 검색 워크플로우

```python
def search_symptom(symptom_text):
    """
    증상 텍스트로 MedDRA 코드 검색
    """
    # Step 1: LLT 검색 (llt_currency=Y만)
    llt_results = search_llt(symptom_text, currency='Y')

    # Step 2: PT 코드 추출
    pt_codes = [llt['pt_code'] for llt in llt_results]

    # Step 3: PT 정보 조회
    pt_info = get_pt_details(pt_codes)

    # Step 4: 계층 정보 조회
    hierarchy = get_hierarchy(pt_codes)

    return {
        'llt_matches': llt_results,
        'pt_info': pt_info,
        'hierarchy': hierarchy
    }
```

### 검색 개선 전략

#### 1. 부분 일치 검색

```bash
# "통증"으로 검색 (두통, 복통, 요통 등 모두 찾기)
grep "통증" ascii-281/llt.asc | grep "Y\$\$"
```

#### 2. 다중 키워드 검색

```bash
# "구역" 또는 "구토" 검색
grep -E "구역|구토" ascii-281/llt.asc | grep "Y\$\$"
```

#### 3. 대소문자 무시 검색 (필요시)

```bash
grep -i "headache" ascii-281/llt.asc
# 한글은 대소문자 구분 없음
```

## 4. 검색 결과 필터링

### Currency 체크

```bash
# 현재 사용 중인 용어만 필터링
grep "두통" ascii-281/llt.asc | grep "Y\$\$$"
```

### PT 코드로 그룹화

```bash
# 특정 PT에 속한 모든 LLT 찾기
grep "\$10019211\$" ascii-281/llt.asc
```

**결과 예시:**
```
10008012$두통 또는 두통$10019211$$$$$$$N$$
10019211$두통$10019211$$$$$$$Y$$
10019212$두통 NOS$10019211$$$$$$$Y$$
10058674$편두통 이외의 두통$10019211$$$$$$$Y$$
```

## 5. 실전 검색 예시

### 시나리오 1: 환자가 "배가 아프다"고 호소

**검색 과정:**

```bash
# 1. LLT 검색
grep "복통" ascii-281/llt.asc | grep "Y\$\$$"

# 결과: PT 코드 10000081 확인

# 2. PT 상세 정보
grep "^10000081\$" ascii-281/pt.asc

# 결과: 10000081$복통$$10017947$$$$$$$$

# 3. 전체 계층 조회
grep "^10000081\$" ascii-281/mdhier.asc
```

**최종 결과:**
- **LLT**: 복통
- **PT 코드**: 10000081
- **PT명**: 복통
- **SOC**: 각종 위장관 장애 (10017947)

### 시나리오 2: 환자가 "어지럽다"고 호소

**주의사항:** "어지러움"은 여러 SOC에 속할 수 있음 (다중 분류)

```bash
grep "^10013573\$" ascii-281/mdhier.asc
```

**결과:**
```
10013573$10007609$10082206$10007541$어지러움$심장 징후 및 증상 NEC$심장 장애, 징후, 증상 NEC$각종 심장 장애$Card$$10029205$N$
10013573$10029306$10029305$10029205$어지러움$신경학적 징후 및 증상 NEC$신경학적 장애 NEC$각종 신경계 장애$Nerv$$10029205$Y$
10013573$10009193$10011954$10047065$어지러움$순환 허탈 및 쇼크$비특이성 혈압 및 혈압 감소 장애 및 쇼크$각종 혈관 장애$Vasc$$10029205$N$
```

**해석:**
- Primary SOC (Y): 각종 신경계 장애 (10029205)
- Secondary SOC (N): 각종 심장 장애, 각종 혈관 장애

## 6. 검색 결과 해석 가이드

### LLT Currency 플래그

| 값 | 의미 | 사용 권장 |
|----|------|-----------|
| **Y** | 현재 사용 중 | ✅ 사용 |
| **N** | 구버전/비권장 | ❌ 사용 금지 |

### PT 코드 == LLT 코드

```
10019211$두통$10019211$$$$$$$Y$$
   ↑           ↑
동일 = PT 자체
```

이 경우 해당 LLT가 곧 선호 용어(PT)입니다.

### 빈 필드 처리

```
10000081$복통$$10017947$$$$$$$$
            ↑↑        ↑↑↑↑↑↑↑
         빈 필드들 (파싱 시 주의)
```

파싱 시 연속된 `$$`를 올바르게 처리해야 합니다.

## 7. 검색 최적화 팁

### 1. 인덱스 구축
- LLT명 → PT 코드 맵 사전 생성
- PT 코드 → 상세 정보 맵 구축
- 메모리 캐싱으로 검색 속도 향상

### 2. 정규화
- 띄어쓰기 제거: "복 통" → "복통"
- 동의어 처리: "배앓이" → "복통"
- 표기 변형 처리

### 3. 유사도 검색
- Levenshtein 거리 계산
- 형태소 분석 활용
- 부분 문자열 매칭

## 8. 자주 검색하는 증상 목록

### 소화기계
- 복통 (10000081)
- 구역 (10028813)
- 구토 (10047700)
- 설사 (10012735)
- 변비 (10010774)

### 신경계
- 두통 (10019211)
- 어지러움 (10013573)
- 현기증 (10047340)

### 호흡기계
- 기침 (10011224)
- 호흡곤란 (10013963)

### 전신
- 피로 (10016256)
- 발열 (10037660)

## 다음 단계

검색으로 PT 코드를 찾았다면, [02_계층_탐색.md](02_계층_탐색.md)에서 전체 계층 구조를 탐색하는 방법을 확인하세요.
