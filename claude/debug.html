<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>디버그 테스트</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .log { background: #f5f5f5; padding: 15px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>MedDRA 검색 디버그</h1>
    <button onclick="loadAndTest()">데이터 로드 및 검색 테스트</button>
    <div id="log"></div>

    <script>
        async function loadAndTest() {
            const log = document.getElementById('log');
            log.innerHTML = '<div class="log">시작...</div>';

            try {
                // 1. JSON 로드
                log.innerHTML += '<div class="log">1. JSON 로딩 중...</div>';
                const response = await fetch('meddra_data.json');
                const data = await response.json();
                log.innerHTML += `<div class="log">✅ JSON 로드 완료: LLT ${data.llt.length}개, PT ${data.pt.length}개</div>`;

                // 2. 인덱스 생성
                log.innerHTML += '<div class="log">2. 인덱스 생성 중...</div>';
                const lltIndex = new Map();
                data.llt.forEach(llt => {
                    lltIndex.set(llt.llt_name.toLowerCase(), llt);
                });
                log.innerHTML += `<div class="log">✅ LLT 인덱스 생성 완료: ${lltIndex.size}개</div>`;

                const ptIndex = new Map();
                data.pt.forEach(pt => {
                    ptIndex.set(pt.pt_code, pt);
                });
                log.innerHTML += `<div class="log">✅ PT 인덱스 생성 완료: ${ptIndex.size}개</div>`;

                const hierarchyIndex = new Map();
                data.hierarchy.forEach(hier => {
                    if (!hierarchyIndex.has(hier.pt_code)) {
                        hierarchyIndex.set(hier.pt_code, []);
                    }
                    hierarchyIndex.get(hier.pt_code).push(hier);
                });
                log.innerHTML += `<div class="log">✅ Hierarchy 인덱스 생성 완료: ${hierarchyIndex.size}개</div>`;

                // 3. "두통" 검색 테스트
                log.innerHTML += '<div class="log">3. "두통" 검색 테스트...</div>';
                const searchTerm = '두통';
                const results = [];

                for (const [lltName, llt] of lltIndex) {
                    if (lltName.includes(searchTerm)) {
                        const pt = ptIndex.get(llt.pt_code);
                        if (!pt) {
                            log.innerHTML += `<div class="log">⚠️ PT를 찾을 수 없음: ${llt.pt_code}</div>`;
                            continue;
                        }

                        const hierarchies = hierarchyIndex.get(llt.pt_code) || [];
                        const primaryHierarchy = hierarchies.find(h => h.primary_soc_flag === 'Y') || hierarchies[0];

                        if (!primaryHierarchy) {
                            log.innerHTML += `<div class="log">⚠️ Hierarchy를 찾을 수 없음: ${llt.pt_code}</div>`;
                            continue;
                        }

                        results.push({
                            llt: llt,
                            pt: pt,
                            hierarchy: primaryHierarchy
                        });
                    }
                }

                log.innerHTML += `<div class="log">✅ 검색 완료: ${results.length}개 결과</div>`;

                // 4. 결과 출력
                if (results.length > 0) {
                    log.innerHTML += '<div class="log"><strong>첫 3개 결과:</strong></div>';
                    results.slice(0, 3).forEach((result, i) => {
                        log.innerHTML += `<div class="log">
                            <strong>${i+1}. ${result.pt.pt_name}</strong><br>
                            LLT: ${result.llt.llt_name}<br>
                            PT Code: ${result.pt.pt_code}<br>
                            SOC: ${result.hierarchy.soc_name}
                        </div>`;
                    });
                } else {
                    log.innerHTML += '<div class="log">❌ 검색 결과가 없습니다!</div>';

                    // 디버깅: "두통"이 포함된 LLT가 있는지 확인
                    log.innerHTML += '<div class="log">디버깅: "두통"이 포함된 LLT 찾기...</div>';
                    let count = 0;
                    for (const [lltName, llt] of lltIndex) {
                        if (lltName.includes('두통')) {
                            log.innerHTML += `<div class="log">찾음: "${llt.llt_name}" (${llt.llt_code})</div>`;
                            count++;
                            if (count >= 5) break;
                        }
                    }
                    if (count === 0) {
                        log.innerHTML += '<div class="log">❌ "두통"이 포함된 LLT가 전혀 없습니다!</div>';
                    }
                }

            } catch (error) {
                log.innerHTML += `<div class="log" style="color: red;">❌ 에러: ${error.message}<br>${error.stack}</div>`;
            }
        }
    </script>
</body>
</html>
